name: "Update API Documentation"

on:
  workflow_run:
    workflows: ["CD: NPM publish with tag push"]
    types:
      - completed
  workflow_dispatch: # Allow manual trigger

jobs:
  update-docs:
    name: "Generate and Update API Docs"
    runs-on: ubuntu-latest
    # Only run if the release workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev # or your main branch
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate API documentation
        run: node scripts/generate-api-docs.mjs

      - name: Get version from latest tag
        id: get_version
        run: |
          # Get the latest tag
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Detected version from tag: $VERSION"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet apps/sequelize-guard-docs/content/docs/api/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update API documentation for v${{ steps.get_version.outputs.version }}"
          title: "docs: Update API documentation for v${{ steps.get_version.outputs.version }}"
          body: |
            ## ğŸ“š API Documentation Update

            This PR updates the API documentation after the **v${{ steps.get_version.outputs.version }}** release.

            ### ğŸ‰ Release Version
            **v${{ steps.get_version.outputs.version }}**

            ### ğŸ“ Changes
            - Auto-generated API documentation from TypeScript source code
            - Updated `apps/sequelize-guard-docs/content/docs/api/`
            - Generated **${{ steps.check_changes.outputs.file_count }}** documentation files

            ### ğŸ¤– Generated by
            - **Workflow:** `update-docs.yml`
            - **Triggered by:** Release workflow completion
            - **Script:** `scripts/generate-api-docs.mjs`
            - **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            **Note:** This is an automated PR. Please review the changes before merging.
          branch: docs/update-api-v${{ steps.get_version.outputs.version }}-${{ github.run_number }}
          base: dev
          labels: documentation,automated
          assignees: ${{ github.actor }}

      - name: No changes detected
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "âœ… No changes detected in API documentation"
